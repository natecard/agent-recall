{
	"project": "Agent Recall Super Ralph",
	"version": 2,
	"selection_policy": {
		"agent_decides_priority": true,
		"priority_scale": "1 = highest priority",
		"order_of_operations": ["critical bugfixes", "tracer-bullet feature slices", "polish and quick wins", "refactors"]
	},
	"items": [
		{
			"id": "WM-001",
			"category": "functional",
			"priority": 1,
			"title": "Iteration Record Store",
			"description": "Create structured JSON storage for iteration data. This is Layer 1 of the Weather Model — the raw data that feeds all downstream generation. Each iteration produces a numbered JSON file with deterministic fields capturing outcome, timing, validation results, and git state.",
			"user_story": "As the Ralph loop harness, I need to persist structured iteration data to JSON files so the system can deterministically rebuild forecasts and synthesize climate without relying on unstructured agent prose.",
			"steps": [
				"Create src/agent_recall/ralph/iteration_store.py.",
				"Implement IterationOutcome StrEnum: COMPLETED, VALIDATION_FAILED, SCOPE_REDUCED, BLOCKED, TIMEOUT.",
				"Implement IterationReport dataclass with three field groups: (1) harness-set before agent: iteration, item_id, item_title, started_at; (2) agent-set during work: outcome, summary, failure_reason, gotcha_discovered, pattern_that_worked, scope_change; (3) harness-set after agent: validation_exit_code, validation_hint, files_changed, commit_hash, completed_at, duration_seconds.",
				"Implement to_dict() with datetime ISO formatting and from_dict() with graceful missing-field handling.",
				"Implement IterationReportStore with iterations_dir at ralph_dir/'iterations' and current_path at iterations_dir/'current.json'.",
				"Implement create_for_iteration(iteration, item_id, item_title) that writes current.json with defaults.",
				"Implement finalize_current(validation_exit, validation_hint) that sets completed_at, computes duration, sets COMPLETED if exit==0, archives to {iteration:03d}.json, deletes current.json.",
				"Implement load_current() and save_current() with corrupt-file safety.",
				"Implement load_recent(count=10) returning archived reports newest-first, skipping current.json.",
				"Write tests for round-trip serialization, create/finalize lifecycle, corrupt file handling, load_recent ordering."
			],
			"acceptance": [
				"IterationReport round-trips through to_dict()/from_dict() without data loss.",
				"create_for_iteration writes current.json and creates directories.",
				"finalize_current archives to zero-padded filename and deletes current.json.",
				"finalize_current returns None when current.json missing.",
				"load_current returns None for missing or corrupt files.",
				"load_recent returns correct count in newest-first order.",
				"JSON schema validates with deterministic field names."
			],
			"validation": ["uv run pytest", "uv run ruff check .", "uv run ty check"],
			"passes": true
		},
		{
			"id": "WM-002",
			"category": "functional",
			"priority": 1,
			"title": "Heuristic Extractor",
			"description": "Create an observation-based extraction module that parses validation output, git diff, PRD state changes, and elapsed time into structured iteration report fields — without any LLM calls. This replaces the old pattern where the agent self-reported its learnings. The system now observes artifacts and extracts facts deterministically.",
			"user_story": "As the loop harness, I need to extract structured facts from observable build artifacts so iteration reports are populated from evidence rather than agent self-reporting, producing deterministic output from the same input.",
			"steps": [
				"Create src/agent_recall/ralph/extraction.py.",
				"Implement extract_outcome(validation_exit_code, agent_exit_code, elapsed_seconds, timeout_seconds) returning IterationOutcome: COMPLETED if validation passes, TIMEOUT if elapsed >= timeout, VALIDATION_FAILED otherwise.",
				"Implement extract_failure_reason(validation_output: list[str]) that scans for the first line containing error/failed/exception/assert indicators and returns it truncated to 200 chars, or None.",
				"Implement extract_files_changed(repo_dir: Path) that runs 'git diff --name-only HEAD' and returns the list of changed file paths.",
				"Implement extract_validation_hint(validation_output: list[str]) that finds the first actionable error line, skipping blank lines and separator lines.",
				"Implement extract_from_artifacts(validation_exit, validation_output, agent_exit, elapsed, timeout, repo_dir) returning a dict with keys: outcome, failure_reason, validation_hint, files_changed — all computed from the above functions.",
				"Write tests with fixed input producing deterministic output for each extraction function."
			],
			"acceptance": [
				"extract_outcome returns COMPLETED when validation_exit is 0.",
				"extract_outcome returns TIMEOUT when elapsed >= timeout.",
				"extract_outcome returns VALIDATION_FAILED for non-zero validation exit below timeout.",
				"extract_failure_reason returns first error-indicator line truncated to 200 chars.",
				"extract_failure_reason returns None when no errors found.",
				"extract_files_changed returns list of paths from git diff.",
				"extract_from_artifacts returns a complete dict from the same inputs every time.",
				"Deterministic: same input always produces same output."
			],
			"validation": ["uv run pytest", "uv run ruff check .", "uv run ty check"],
			"passes": true
		},
		{
			"id": "WM-003",
			"category": "functional",
			"priority": 2,
			"title": "Heuristic Forecast Generator",
			"description": "Create the Layer 2 forecast generator that rebuilds RECENT.md entirely from the last N iteration records using pure heuristics — no LLM, runs instantly. Produces markdown with Trajectory (last 5 outcomes), Current Status, Watch For, and Emerging Pattern sections. RECENT.md is overwritten every iteration, never appended to.",
			"user_story": "As the Ralph loop, I need RECENT.md rebuilt between every iteration from structured data so the agent receives a concise tactical forecast instead of an ever-growing prose file.",
			"steps": [
				"Create src/agent_recall/ralph/forecast.py.",
				"Implement ForecastConfig dataclass: window (int, default 5), use_llm (bool, default False), llm_on_consecutive_failures (int, default 2), llm_model (str|None, default None).",
				"Implement ForecastGenerator.__init__ taking ralph_dir, files (FileStorage), optional config.",
				"Implement _empty_forecast() returning default first-iteration RECENT.md content.",
				"Implement _generate_heuristic(reports) building markdown: '# Current Situation' header with timestamp, '## Trajectory' showing last 5 iterations oldest-to-newest with ✓/✗ and truncated hints (50 chars), '## Current Status' with latest outcome, '## Watch For' with gotcha/hint/scope or fallback, '## Emerging Pattern' with pattern_that_worked (omitted if None).",
				"Implement generate(llm=None) that loads recent reports, returns _empty_forecast() if none, delegates to _generate_heuristic() for now (LLM path added in WM-004).",
				"Implement write_forecast(llm=None) that calls generate(), writes to RECENT.md via files.write_tier(KnowledgeTier.RECENT, content), returns content.",
				"Write tests verifying heuristic output for empty reports, single report, five mixed-outcome reports, and missing optional fields."
			],
			"acceptance": [
				"generate() returns _empty_forecast() when no reports exist.",
				"Trajectory shows up to 5 iterations in oldest-to-newest reading order.",
				"Trajectory uses ✓ for COMPLETED and ✗ for all other outcomes.",
				"Watch For shows gotcha_discovered, validation_hint (100 chars), or fallback message.",
				"Emerging Pattern section omitted entirely when pattern_that_worked is None.",
				"write_forecast() overwrites RECENT.md, not appends.",
				"Zero LLM calls in heuristic path."
			],
			"validation": ["uv run pytest", "uv run ruff check .", "uv run ty check"],
			"passes": false
		},
		{
			"id": "WM-006",
			"category": "integration",
			"priority": 3,
			"title": "Loop Integration — Bash Loop Lifecycle Update",
			"description": "Update ralph-agent-recall-loop.sh to use the new Weather Model lifecycle: setup_iteration (create report) → run agent → run validation → finalize_iteration (extract artifacts, finalize report, rebuild forecast, refresh context). Remove old direct memory file append logic. The agent no longer writes to tier files — the system extracts and rebuilds. Post-loop calls synthesize-climate.",
			"user_story": "As a developer using the bash Ralph loop, I need the loop to follow the Weather Model lifecycle where artifacts are extracted by the system and the forecast is rebuilt between iterations, replacing the old pattern of agent-written tier files.",
			"steps": [
				"Add setup_iteration() bash function that calls 'uv run agent-recall ralph create-report --iteration N --item-id ID --item-title TITLE' before agent invocation.",
				"Add finalize_iteration() bash function that calls in strict order: (1) 'uv run agent-recall ralph extract-iteration --iteration N --runtime-dir .agent/ralph/.runtime', (2) 'uv run agent-recall ralph finalize-report --validation-exit $EXIT --validation-hint \"$HINT\"', (3) 'uv run agent-recall ralph rebuild-forecast', (4) 'uv run agent-recall ralph refresh-context --task \"$TITLE\" --item \"$ID\" --iteration N'.",
				"Wrap each CLI call with '|| true' to prevent loop halt on failure, log warnings to stderr.",
				"Guard all uv calls with 'command -v uv >/dev/null 2>&1'.",
				"Remove old lines that directly append/echo to .agent/GUARDRAILS.md, .agent/STYLE.md, .agent/RECENT.md.",
				"Call setup_iteration before run_agent in the main loop.",
				"Call finalize_iteration after run_validation in the main loop.",
				"Add post-loop call to 'uv run agent-recall ralph synthesize-climate' when loop exits.",
				"Ensure rebuild-forecast completes BEFORE refresh-context (RECENT.md must exist before context assembly)."
			],
			"acceptance": [
				"setup_iteration creates current.json before agent starts.",
				"finalize_iteration runs extract → finalize → rebuild → refresh in order.",
				"Each finalize step uses '|| true' so failures don't halt the loop.",
				"rebuild-forecast completes before refresh-context.",
				"No direct tier file append/echo logic remains in the script.",
				"Post-loop synthesize-climate is called on exit.",
				"Loop functions correctly in environments without uv."
			],
			"validation": ["uv run pytest", "uv run ruff check .", "uv run ty check"],
			"passes": false
		},
		{
			"id": "WM-007",
			"category": "functional",
			"priority": 4,
			"title": "Agent Prompt Simplification",
			"description": "Replace the current agent-prompt.md that instructs the agent to write to GUARDRAILS.md, STYLE.md, and RECENT.md with a simplified contract where the agent only works on code and updates current.json with structured outcome fields. Tier files become read-only context injected by the system. Deprecate tier_writer.py usage from the loop iteration path.",
			"user_story": "As the Ralph loop system, I need the agent to follow a strict read-only contract for tier files and only write structured JSON to current.json, so the system controls all tier file content and prevents bloat.",
			"steps": [
				"Create or update agent-prompt.md (at src/agent_recall/ralph/templates/agent-prompt.md or equivalent).",
				"Write '## Context Provided' section listing GUARDRAILS.md, STYLE.md, RECENT.md as read-only, plus PRD state and iteration report location.",
				"Write '## Task Selection' with priority order: critical bugfixes → tracer-bullet slices → quick wins → refactors.",
				"Write '## Execution' with scope reduction protocol: 'HANG ON A SECOND' trigger when task too large.",
				"Write '## Required Output' specifying current.json schema: outcome (enum), summary, failure_reason, gotcha_discovered, pattern_that_worked, scope_change.",
				"Write '## What NOT To Do' with explicit prohibitions: do NOT write to GUARDRAILS.md, STYLE.md, RECENT.md; do NOT append to progress.txt; do NOT start a second feature.",
				"Mark tier_writer.py calls in loop.py _write_tier_entries() for removal — the Weather Model replaces this with extraction + forecast + synthesis.",
				"Ensure prompt template is parameterizable with item_id, item_title, description, validation_command."
			],
			"acceptance": [
				"Prompt states tier files are read-only.",
				"Prompt specifies current.json JSON schema with all six agent-writable fields.",
				"Prompt lists all valid outcome enum values.",
				"Prompt includes explicit '❌ Do NOT' prohibitions.",
				"Prompt does not instruct the agent to write to GUARDRAILS.md, STYLE.md, or RECENT.md.",
				"Prompt includes task selection priority and scope reduction protocol.",
				"tier_writer.py is no longer called from the iteration path."
			],
			"validation": ["uv run pytest", "uv run ruff check .", "uv run ty check"],
			"passes": false
		},
		{
			"id": "WM-008",
			"category": "functional",
			"priority": 5,
			"title": "CLI Commands for Weather Model",
			"description": "Add CLI commands to the Ralph Typer sub-application for the Weather Model operations: extract-iteration (run heuristic extraction on iteration artifacts), create-report and finalize-report (iteration lifecycle), rebuild-forecast (Layer 2), and synthesize-climate (Layer 3). These are the commands called by the bash loop and available for manual use.",
			"user_story": "As the bash loop script and as a developer, I need CLI commands for each Weather Model operation so the three-layer architecture can be driven from the shell.",
			"steps": [
				"Add 'create-report' command with --iteration (int), --item-id (str), --item-title (str). Creates current.json via IterationReportStore.",
				"Add 'finalize-report' command with --validation-exit (int), --validation-hint (str). Finalizes and archives via IterationReportStore.",
				"Add 'extract-iteration' command with --iteration (int), --runtime-dir (Path). Reads validation log and git state, runs heuristic extraction, updates current.json with extracted fields via save_current().",
				"Add 'rebuild-forecast' command with --use-llm flag. Reads ralph.forecast config from config.yaml. Instantiates ForecastGenerator. Calls write_forecast(). Displays content length.",
				"Add 'synthesize-climate' command with --force flag. Loads all archived reports. Extracts guardrail and style candidates. Uses LLM to synthesize. Writes to GUARDRAILS.md and STYLE.md. Displays entry counts.",
				"All commands check .agent directory exists, exit code 1 if missing.",
				"Write tests for each command with mock filesystem."
			],
			"acceptance": [
				"'ralph create-report --iteration 1 --item-id AUTH-001 --item-title \"JWT\"' creates current.json.",
				"'ralph finalize-report --validation-exit 0' archives to 001.json and deletes current.json.",
				"'ralph extract-iteration --iteration 1 --runtime-dir .agent/ralph/.runtime' populates current.json with extracted fields.",
				"'ralph rebuild-forecast' overwrites RECENT.md and displays char count.",
				"'ralph rebuild-forecast --use-llm' attempts LLM, falls back to heuristic.",
				"'ralph synthesize-climate' writes both GUARDRAILS.md and STYLE.md.",
				"'ralph synthesize-climate --force' bypasses recency check.",
				"All commands exit 1 without .agent directory."
			],
			"validation": ["uv run pytest", "uv run ruff check .", "uv run ty check"],
			"passes": false
		},
		{
			"id": "WM-004",
			"category": "functional",
			"priority": 6,
			"title": "LLM-Enhanced Forecast Generation",
			"description": "Extend ForecastGenerator in forecast.py with the optional LLM path. Triggered only when consecutive failures exceed the configured threshold AND an LLM provider is available. Uses a small model (e.g., qwen3:1.5b) for quick turnaround. Falls back to heuristic gracefully on any LLM error.",
			"user_story": "As a developer, when the Ralph loop hits consecutive failures, I need a smarter forecast from a small LLM that can identify deeper patterns — while always falling back to instant heuristics if LLM is unavailable.",
			"steps": [
				"Define FORECAST_LLM_PROMPT constant with {iteration_summaries} and {current_item} placeholders requesting Trajectory, Current Status, Watch For, Emerging Pattern in max 150 words.",
				"Implement async _generate_with_llm(reports, llm) that builds PASS/FAIL summaries with failure_reason and gotcha_discovered, calls llm.generate() with temperature=0.3 and max_tokens=400, prepends standard header.",
				"Update generate() to count consecutive failures (stop at first COMPLETED), trigger LLM only when config.use_llm AND llm not None AND failures >= threshold.",
				"Wrap _generate_with_llm in try/except, fall back to _generate_heuristic on any error.",
				"Update write_forecast() to handle async LLM path via asyncio.run when appropriate.",
				"Add ralph.forecast config section to config.yaml schema: window, use_llm, llm_on_consecutive_failures, llm_model.",
				"Write tests for LLM trigger conditions, fallback behavior, and prompt construction."
			],
			"acceptance": [
				"LLM triggers only when all three conditions met: config, provider, threshold.",
				"LLM does not trigger when failures below threshold.",
				"LLM error falls back to heuristic without exception.",
				"Prompt includes iteration summaries with PASS/FAIL prefix.",
				"LLM called with temperature=0.3 and max_tokens=400.",
				"Config reads from ralph.forecast section with sensible defaults.",
				"Missing config section uses heuristic-only defaults."
			],
			"validation": ["uv run pytest", "uv run ruff check .", "uv run ty check"],
			"passes": false
		},
		{
			"id": "WM-005",
			"category": "functional",
			"priority": 7,
			"title": "Climate Synthesizer (Layer 3)",
			"description": "Create the Layer 3 climate synthesizer that runs once at loop end to distill all accumulated iteration reports into stable GUARDRAILS.md and STYLE.md content. Extracts failure_reason and gotcha_discovered for guardrails, pattern_that_worked for style. Deduplicates by frequency. Requires LLM for semantic synthesis. Tracks synthesis state to avoid redundant runs.",
			"user_story": "As a developer, I need accumulated iteration learnings automatically distilled into concise guardrails and style patterns at loop end, so future loops benefit from past experience without files growing unbounded.",
			"steps": [
				"Create src/agent_recall/ralph/synthesis.py.",
				"Implement SynthesisConfig: max_guardrails (int, 30), max_style (int, 30), auto_after_loop (bool, True).",
				"Implement ClimateSynthesizer.__init__ taking ralph_dir, files (FileStorage), llm, optional config.",
				"Implement _extract_guardrail_candidates(reports) collecting all non-None failure_reason and gotcha_discovered.",
				"Implement _extract_style_candidates(reports) collecting all non-None pattern_that_worked.",
				"Implement _deduplicate_candidates(candidates) grouping similar entries, returning (entry, frequency) sorted by frequency.",
				"Define GUARDRAILS_SYNTHESIS_PROMPT and STYLE_SYNTHESIS_PROMPT requesting concise bullet-format rules capped at max entries.",
				"Implement async synthesize_guardrails(candidates) and synthesize_style(candidates) calling LLM with temperature=0.2, max_tokens=800.",
				"Implement async synthesize() loading all reports, extracting candidates, calling both synthesis functions, writing to tier files, writing synthesis_state.json with last_synthesized_at and iteration_count.",
				"Implement should_synthesize() returning False when iteration count unchanged since last synthesis.",
				"Add ralph.synthesis config section: auto_after_loop, max_guardrails, max_style.",
				"Write tests for candidate extraction, deduplication, state tracking, and synthesis with mock LLM."
			],
			"acceptance": [
				"Extracts failure_reason and gotcha_discovered for guardrails, pattern_that_worked for style.",
				"Deduplicates candidates by frequency.",
				"Synthesis respects max_guardrails and max_style limits.",
				"Writes both GUARDRAILS.md and STYLE.md (overwrite, not append).",
				"synthesis_state.json tracks last run.",
				"should_synthesize() returns False when no new data.",
				"Empty candidates produce minimal valid tier content.",
				"LLM unavailability raises clear error (no silent fallback for Layer 3)."
			],
			"validation": ["uv run pytest", "uv run ruff check .", "uv run ty check"],
			"passes": false
		}
	]
}
